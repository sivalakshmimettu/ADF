name: Deployment in ADF

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (qa or prod)'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TARGET_ENV: ${{ github.event.inputs.environment }}
      FACTORY_NAME: ${{ vars.FACTORY_NAME }}
      SERVICE_ENDPOINT: ${{ vars.SERVICE_ENDPOINT }}
      CONFIG_VALUES: ${{ vars[github.event.inputs.environment] }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Show selected environment
        run: |
          echo "Deploying to environment: $TARGET_ENV"
          echo "Loaded CONFIG_VALUES: $CONFIG_VALUES"

      - name: Extract config values and export as environment variables
        run: |
          for pair in ${CONFIG_VALUES//;/ }; do
            IFS='=' read -r key value <<< "$pair"
            echo "$key=$value"
            echo "$key=$value" >> $GITHUB_ENV
          done

      - name: Debug environment variables
        run: |
          echo "FACTORY_NAME = $FACTORY_NAME"
          echo "SERVICE_ENDPOINT = $SERVICE_ENDPOINT"

      - name: Show parameters.json before update
        run: cat ARMTemplateForFactory/parameters.json

      - name: Update parameters.json using jq
        run: |
          echo "Updating parameters.json using jq..."
          jq \
            --arg factoryName "$FACTORY_NAME" \
            --arg serviceEndpoint "$SERVICE_ENDPOINT" \
            '.parameters.factoryName.value = $factoryName
             | .parameters.LS_ABLOB_properties_typeProperties_serviceEndpoint.value = $serviceEndpoint' \
            ARMTemplateForFactory/parameters.json > temp.json && mv temp.json ARMTemplateForFactory/parameters.json

      - name: Show parameters.json after update
        run: cat ARMTemplateForFactory/parameters.json

      - name: Define and export ARTIFACT_ID
        run: |
          ARTIFACT_ID="arm-template-${{ github.run_number }}-${{ github.event.inputs.environment }}-${GITHUB_SHA::7}"
          echo "Generated Artifact ID: $ARTIFACT_ID"
          echo "ARTIFACT_ID=$ARTIFACT_ID" >> $GITHUB_ENV
          echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
        id: versioning

      - name: Upload ARM Template and Parameters as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.versioning.outputs.artifact_id }}
          path: |
            ARMTemplateForFactory/parameters.json
            ARMTemplateForFactory/ARMTemplate.json
